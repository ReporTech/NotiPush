<!DOCTYPE html>
<html lang="es" class="light dark">

<head>

  <meta charset="UTF-8">
  <title>Notifica - Reponotipush</title>

  <script src="js/registraServiceWorker.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#fffbfe">
  <link rel="icon" sizes="32x32" href="favicon.ico">
  <link rel="manifest" href="site.webmanifest">
  <script src="ungap/custom-elements.js"></script>
  <script type="module" src="js/configura.js"></script>
  <link rel="stylesheet" href="css/estilos.css">
  <link rel="stylesheet" href="css/transicion_pestanas.css">
  <link rel="expect" blocking="render" href="#navtabfixed">
  <!-- Se eliminó el CDN de Tailwind CSS y los estilos personalizados -->

</head>

<body onload="preparaVista()">

  <md-top-app-bar class="center-aligned">
    <h1>Notificaciones Push</h1>
  </md-top-app-bar>
  <nav-tab-fixed id="tab"></nav-tab-fixed>
<main>

  <menu style="display: flex; list-style: none; flex-wrap: wrap; gap: 0.5rem;">
    <li>
      <button id="btnSuscribe" class="md-filled-button" type="button" hidden onclick="suscribe()">
        Suscríbete
      </button>
    </li>
    <li>
      <button id="btnCancela" class="md-outline-button" type="button" hidden onclick="cancela()">
        Cancela suscripción
      </button>
    </li>
    <li>
      <button id="btnNotifica" class="md-filled-button" type="button" hidden onclick="notificaDesdeElServidor()">
        Notifica
      </button>
    </li>
    <li>
      <a href="srv/genera-llaves.php" target="_blank">Genera llaves</a>
    </li>
  </menu>

  <!-- Cuadro de texto para el mensaje de la notificación -->
  <div style="margin-bottom: 1rem;">
    <label for="txtMensajeNotificacion" style="display: block; margin-bottom: 0.5rem;">
      Mensaje de la Notificación:
    </label>
    <input type="text" id="txtMensajeNotificacion" placeholder="Escribe tu mensaje aquí..."
           style="width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 0.25rem; box-sizing: border-box;">
  </div>

  <p>
    <output id="outEstado" style="width: 90%;">
      <progress max="100">Cargando&hellip;</progress>
    </output>
  </p>

  <fieldset>
    <legend>Reporte de envío a endpoints</legend>

    <dl id="reporte"></dl>

  </fieldset>

  <script type="module">

    import { exportaAHtml } from "./lib/js/exportaAHtml.js"
    import {
      activaNotificacionesPush
    } from "./lib/js/activaNotificacionesPush.js"
    import { getSuscripcionPush } from "./lib/js/getSuscripcionPush.js"
    import { suscribeAPush } from "./lib/js/suscribeAPush.js"
    import { cancelaSuscripcionPush } from "./lib/js/cancelaSuscripcionPush.js"
    import { consumeJson } from "./lib/js/consumeJson.js"
    import { enviaJson } from "./lib/js/enviaJson.js"
    import { muestraError } from "./lib/js/muestraError.js"
    import { muestraObjeto } from "./lib/js/muestraObjeto.js"
    import { urlBase64ToUint8Array } from "./lib/js/urlBase64ToUint8Array.js"
    import {
      calculaDtoParaSuscripcion
    } from "./lib/js/calculaDtoParaSuscripcion.js"

    const applicationServerKey = urlBase64ToUint8Array(
      "BMBlr6YznhYMX3NgcWIDRxZXs0sh7tCv7_YCsWcww0ZCv9WGg-tRCXfMEHTiBPCksSqeve1twlbmVAZFv7GSuj0")
    /** @enum {string} */
    const Estado = {
      CALCULANDO: "Calculando…",
      SUSCRITO: "Suscrito",
      DESUSCRITO: "Sin suscripción",
      INCOMPATIBLE: "Incompatible"
    }

    /**
     * Prepara la vista inicial de la aplicación, comprobando el estado de la suscripción.
     */
    async function preparaVista() {
      try {
        await activaNotificacionesPush("sw.js")
        const suscripcion = await getSuscripcionPush()
        if (suscripcion === null) {
          muestraEstado(Estado.DESUSCRITO)
        } else {
          // Si ya está suscrito, actualiza la suscripción en el servidor si es necesario.
          const dto = calculaDtoParaSuscripcion(suscripcion)
          await enviaJson("srv/suscripcion-modifica.php", dto)
          muestraEstado(Estado.SUSCRITO)
        }
      } catch (error) {
        muestraEstado(Estado.INCOMPATIBLE)
        muestraError(error)
      }
    }
    exportaAHtml(preparaVista)

    /**
     * Envía una notificación push desde el servidor, incluyendo el mensaje del cuadro de texto.
     */
    async function notificaDesdeElServidor() {
      try {
        reporte.innerHTML =
          /* html */ `<progress max="100">Cargando&hellip;</progress>`

        // Obtener el mensaje del cuadro de texto
        const mensajeInput = document.getElementById("txtMensajeNotificacion");
        const mensaje = mensajeInput ? mensajeInput.value : "";

        // Enviar el mensaje al servidor.
        // El script PHP (srv/notifica.php) deberá ser modificado para recibir este 'mensaje'
        // y usarlo en el payload de la notificación push.
        const render = await enviaJson("srv/notifica.php", { mensaje: mensaje });

        await muestraObjeto(document, render.body)
      } catch (error) {
        muestraError(error)
      }
    }
    exportaAHtml(notificaDesdeElServidor)

    /**
     * Suscribe al usuario a las notificaciones push.
     */
    async function suscribe() {
      try {
        muestraEstado(Estado.CALCULANDO)
        const suscripcion = await suscribeAPush(applicationServerKey)
        // Agrega la suscripción al servidor.
        const dto = calculaDtoParaSuscripcion(suscripcion)
        await enviaJson("srv/suscripcion-modifica.php", dto)
        muestraEstado(Estado.SUSCRITO)
      } catch (error) {
        muestraError(error)
      }
    }
    exportaAHtml(suscribe)

    /**
     * Cancela la suscripción del usuario a las notificaciones push.
     */
    async function cancela() {
      try {
        muestraEstado(Estado.CALCULANDO)
        const suscripcion = await cancelaSuscripcionPush()
        if (suscripcion !== null) {
          // Elimina la suscripción en el servidor.
          const dto = calculaDtoParaSuscripcion(suscripcion)
          await enviaJson("srv/suscripcion-elimina.php", dto)
          muestraEstado(Estado.DESUSCRITO)
        }
      } catch (error) {
        muestraError(error)
      }
    }
    exportaAHtml(cancela)

    /**
     * Muestra el estado actual de la suscripción y habilita/deshabilita botones.
     * @param {Estado} estado
     */
    function muestraEstado(estado) {
      outEstado.value = estado
      const btnSuscribe = document.getElementById("btnSuscribe");
      const btnCancela = document.getElementById("btnCancela");
      const btnNotifica = document.getElementById("btnNotifica");
      const txtMensajeNotificacion = document.getElementById("txtMensajeNotificacion");

      if (estado === Estado.INCOMPATIBLE || estado === Estado.CALCULANDO) {
        btnSuscribe.hidden = true
        btnCancela.hidden = true
        btnNotifica.hidden = true
        txtMensajeNotificacion.disabled = true; // Deshabilita el input
      } else if (estado === Estado.SUSCRITO) {
        btnSuscribe.hidden = true
        btnCancela.hidden = false
        btnNotifica.hidden = false
        txtMensajeNotificacion.disabled = false; // Habilita el input
      } else if (estado === Estado.DESUSCRITO) {
        btnSuscribe.hidden = false
        btnCancela.hidden = true
        btnNotifica.hidden = true
        txtMensajeNotificacion.disabled = true; // Deshabilita el input
      }
    }

  </script>
</main>
  <nav-drw></nav-drw>

</body>

</html>
